#!/usr/bin/env bash
set -euo pipefail

VERSION="0.3.0"
MODEL="haiku"
SKIP_ADD=false
DIRECT=false

usage() {
  cat <<EOF
cmt - AI-powered git commit messages. Fast.

Usage: cmt [options] [message]

Options:
  -d, --direct          Skip confirmation, commit immediately
  -m, --model <model>   Claude model to use (default: haiku)
  --no-add              Skip automatic 'git add -A'
  -v, --version         Show version
  -h, --help            Show help

If [message] is provided, commits directly with that message.
Otherwise, generates a message and asks for confirmation.
EOF
}

# Parse arguments
message_args=()
while [[ $# -gt 0 ]]; do
  case "$1" in
    -m|--model)
      MODEL="${2:?Missing model name}"
      shift 2
      ;;
    -d|--direct)
      DIRECT=true
      shift
      ;;
    --no-add)
      SKIP_ADD=true
      shift
      ;;
    -v|--version)
      echo "cmt $VERSION"
      exit 0
      ;;
    -h|--help)
      usage
      exit 0
      ;;
    --)
      shift
      message_args+=("$@")
      break
      ;;
    -*)
      echo "Unknown option: $1" >&2
      usage >&2
      exit 1
      ;;
    *)
      message_args+=("$1")
      shift
      ;;
  esac
done

# Stage changes
if [[ "$SKIP_ADD" == false ]]; then
  git add -A
fi

# If message provided, commit directly
if [[ ${#message_args[@]} -gt 0 ]]; then
  git commit -m "${message_args[*]}"
  exit 0
fi

# Exit early when nothing is staged
if git diff --cached --quiet; then
  echo "No staged changes to commit"
  exit 1
fi

# Spinner
spinner_pid=""

spinner() {
  local frames="⠋⠙⠹⠸⠼⠴⠦⠧⠇⠏"
  while true; do
    for (( i=0; i<${#frames}; i++ )); do
      printf "\r\033[33m${frames:$i:1}\033[0m Generating commit message..."
      sleep 0.08
    done
  done
}

cleanup() {
  if [[ -n "$spinner_pid" ]]; then
    kill "$spinner_pid" 2>/dev/null || true
    wait "$spinner_pid" 2>/dev/null || true
    printf "\r\033[K"
  fi
  trap - INT
  exit 1
}
trap cleanup INT

# Build context: stat summary + truncated diff
diff_input="$(git diff --cached --stat --no-color && echo '---' && git diff --cached --no-color --unified=2 | head -c 40000)"

generate_message() {
  if [[ -t 1 ]]; then
    spinner & disown
    spinner_pid=$!
  fi

  raw="$(claude -p --model "$MODEL" --effort low --output-format text --no-session-persistence \
    "Write a conventional commit message for this diff.
Format:
<type>(<optional scope>): <subject>

<body>

Rules for the subject line:
- Single line, max 72 chars
- Lowercase, imperative mood
- No period at end

Rules for the body:
- Briefly explain WHAT changed and WHY (not how)
- Wrap lines at 72 chars
- 1-3 lines max, skip if the subject is self-explanatory
- Do NOT repeat the subject

Output ONLY the commit message (subject + optional body), nothing else." <<< "$diff_input")"

  trap - INT
  if [[ -n "$spinner_pid" ]]; then
    kill "$spinner_pid" 2>/dev/null || true
    wait "$spinner_pid" 2>/dev/null || true
    printf "\r\033[K"
  fi

  # Parse subject (first line) and body (rest)
  subject="$(echo "$raw" | head -n1)"
  subject="${subject//$'\n'/}"
  body="$(echo "$raw" | tail -n +2 | sed '/./,$!d')"  # strip leading blank lines
}

do_commit() {
  if [[ -n "$body" ]]; then
    git commit -m "$subject" -m "$body"
  else
    git commit -m "$subject"
  fi
}

show_message() {
  echo
  echo -e "  \033[32m✓\033[0m \033[1m$subject\033[0m"
  if [[ -n "$body" ]]; then
    echo
    while IFS= read -r line; do
      echo -e "    \033[2m$line\033[0m"
    done <<< "$body"
  fi
  echo
}

# Generate initial message
generate_message

if [[ -z "$subject" ]]; then
  echo "Failed to generate commit message"
  exit 1
fi

# Direct mode: commit immediately
if [[ "$DIRECT" == true ]]; then
  show_message
  do_commit
  exit 0
fi

# Interactive confirmation loop
while true; do
  show_message
  echo -e "  \033[36;1m[a]\033[0m accept  \033[33;1m[e]\033[0m edit subject  \033[33;1m[d]\033[0m edit description  \033[35;1m[r]\033[0m regenerate  \033[31;1m[q]\033[0m quit"
  echo
  printf "  > "
  read -r -n1 choice
  echo

  case "${choice,,}" in
    a|"")
      do_commit
      exit 0
      ;;
    e)
      printf "\n  Subject: "
      read -r -e -i "$subject" edited_subject
      if [[ -n "$edited_subject" ]]; then
        subject="$edited_subject"
      else
        echo "  Empty subject, keeping original."
      fi
      ;;
    d)
      echo
      echo -e "  Enter description (\033[2mempty line to finish, - to clear\033[0m):"
      new_body=""
      while true; do
        printf "  > "
        IFS= read -r line
        [[ -z "$line" ]] && break
        if [[ "$line" == "-" ]]; then
          new_body=""
          break
        fi
        if [[ -n "$new_body" ]]; then
          new_body="$new_body"$'\n'"$line"
        else
          new_body="$line"
        fi
      done
      body="$new_body"
      ;;
    r)
      generate_message
      if [[ -z "$subject" ]]; then
        echo "Failed to generate commit message"
        exit 1
      fi
      ;;
    q)
      echo "  Aborted."
      exit 1
      ;;
    *)
      echo "  Invalid choice."
      ;;
  esac
done
