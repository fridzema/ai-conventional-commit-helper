#!/usr/bin/env bash
set -euo pipefail

VERSION="0.2.0"
MODEL="haiku"
SKIP_ADD=false
DIRECT=false

usage() {
  cat <<EOF
cmt - AI-powered git commit messages. Fast.

Usage: cmt [options] [message]

Options:
  -d, --direct          Skip confirmation, commit immediately
  -m, --model <model>   Claude model to use (default: haiku)
  --no-add              Skip automatic 'git add -A'
  -v, --version         Show version
  -h, --help            Show help

If [message] is provided, commits directly with that message.
Otherwise, generates a message and asks for confirmation.
EOF
}

# Parse arguments
message_args=()
while [[ $# -gt 0 ]]; do
  case "$1" in
    -m|--model)
      MODEL="${2:?Missing model name}"
      shift 2
      ;;
    -d|--direct)
      DIRECT=true
      shift
      ;;
    --no-add)
      SKIP_ADD=true
      shift
      ;;
    -v|--version)
      echo "cmt $VERSION"
      exit 0
      ;;
    -h|--help)
      usage
      exit 0
      ;;
    --)
      shift
      message_args+=("$@")
      break
      ;;
    -*)
      echo "Unknown option: $1" >&2
      usage >&2
      exit 1
      ;;
    *)
      message_args+=("$1")
      shift
      ;;
  esac
done

# Stage changes
if [[ "$SKIP_ADD" == false ]]; then
  git add -A
fi

# If message provided, commit directly
if [[ ${#message_args[@]} -gt 0 ]]; then
  git commit -m "${message_args[*]}"
  exit 0
fi

# Exit early when nothing is staged
if git diff --cached --quiet; then
  echo "No staged changes to commit"
  exit 1
fi

# Spinner
spinner_pid=""

spinner() {
  local frames="⠋⠙⠹⠸⠼⠴⠦⠧⠇⠏"
  while true; do
    for (( i=0; i<${#frames}; i++ )); do
      printf "\r\033[33m${frames:$i:1}\033[0m Generating commit message..."
      sleep 0.08
    done
  done
}

cleanup() {
  if [[ -n "$spinner_pid" ]]; then
    kill "$spinner_pid" 2>/dev/null || true
    wait "$spinner_pid" 2>/dev/null || true
    printf "\r\033[K"
  fi
  trap - INT
  exit 1
}
trap cleanup INT

# Build context: stat summary + truncated diff
diff_input="$(git diff --cached --stat --no-color && echo '---' && git diff --cached --no-color --unified=2 | head -c 40000)"

generate_message() {
  if [[ -t 1 ]]; then
    spinner & disown
    spinner_pid=$!
  fi

  msg="$(claude -p --model "$MODEL" --effort low --output-format text --no-session-persistence \
    "Write a conventional commit message for this diff.
Format: <type>(<optional scope>): <description>
Types: feat fix refactor docs style test chore perf ci build
Rules:
- Single line, max 72 chars
- Lowercase, imperative mood
- No period at end
- Output ONLY the message, nothing else" <<< "$diff_input")"

  trap - INT
  if [[ -n "$spinner_pid" ]]; then
    kill "$spinner_pid" 2>/dev/null || true
    wait "$spinner_pid" 2>/dev/null || true
    printf "\r\033[K"
  fi

  msg="${msg//$'\n'/}"
}

# Generate initial message
generate_message

if [[ -z "$msg" ]]; then
  echo "Failed to generate commit message"
  exit 1
fi

# Direct mode: commit immediately
if [[ "$DIRECT" == true ]]; then
  echo -e "\033[32m✓\033[0m $msg"
  git commit -m "$msg"
  exit 0
fi

# Interactive confirmation loop
while true; do
  echo -e "\n\033[32m✓\033[0m $msg\n"
  printf "  \033[36m[A]ccept\033[0m  \033[33m[E]dit\033[0m  \033[35m[R]egenerate\033[0m  \033[31m[Q]uit\033[0m  "
  read -r -n1 choice
  echo

  case "${choice,,}" in
    a|"")
      git commit -m "$msg"
      exit 0
      ;;
    e)
      printf "\n  Enter commit message: "
      read -r edited_msg
      if [[ -n "$edited_msg" ]]; then
        msg="$edited_msg"
        git commit -m "$msg"
        exit 0
      else
        echo "  Empty message, try again."
      fi
      ;;
    r)
      generate_message
      if [[ -z "$msg" ]]; then
        echo "Failed to generate commit message"
        exit 1
      fi
      ;;
    q)
      echo "  Aborted."
      exit 1
      ;;
    *)
      echo "  Invalid choice."
      ;;
  esac
done
